<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Régua de Lâmina com Gráficos</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        .ruler {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            height: 30px;
            background-color: #f0f0f0;
            border: 2px solid #000;
            margin-bottom: 20px;
            position: relative;
        }

        .ruler div {
            width: 30%;
            text-align: center;
            padding: 5px;
            border: 1px solid #000;
            background-color: #d9d9d9;
            position: absolute;
        }

        .lc {
            left: 0;
        }

        .m {
            left: 50%;
            transform: translateX(-50%);
        }

        .lr {
            right: 0;
        }

        .chart-container {
            width: 100%;
            margin-top: 20px;
        }

        .save-button {
            margin-top: 10px;
        }

        .history-container {
            width: 100%;
            margin-top: 20px;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        .history-details, .history-chart {
            width: 45%;
        }

        @media (max-width: 600px) {
            .history-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .history-details, .history-chart {
                width: 100%;
                margin-bottom: 10px;
            }

            .chart-container, .history-chart canvas {
                width: 100% !important;
                height: 200px !important;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-database-compat.js"></script>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-4 p-3">
                <h3>Inserir Dados Faca Superior</h3>
                <form id="laminaFormSuperior" class="form-inline">
                    <div class="form-group mx-sm-3 mb-2">
                        <label for="lcSuperior" class="sr-only">LC:</label>
                        <input type="number" id="lcSuperior" name="lc" class="form-control" placeholder="LC" maxlength="3">
                    </div>
                    <div class="form-group mx-sm-3 mb-2">
                        <label for="mSuperior" class="sr-only">M:</label>
                        <input type="number" id="mSuperior" name="m" class="form-control" placeholder="M" maxlength="3">
                    </div>
                    <div class="form-group mx-sm-3 mb-2">
                        <label for="lrSuperior" class="sr-only">LR:</label>
                        <input type="number" id="lrSuperior" name="lr" class="form-control" placeholder="LR" maxlength="3">
                    </div>
                    <button type="button" class="btn btn-primary mb-2" onclick="updateRuler('Superior')">Inserir</button>
                </form>
                <div class="ruler">
                    <div class="lc" id="lcDisplaySuperior"></div>
                    <div class="m" id="mDisplaySuperior"></div>
                    <div class="lr" id="lrDisplaySuperior"></div>
                </div>
                <button class="btn btn-success save-button" onclick="saveToFirebase('Superior')">Salvar no Firebase</button>

                <h3>Inserir Dados Faca Inferior</h3>
                <form id="laminaFormInferior" class="form-inline">
                    <div class="form-group mx-sm-3 mb-2">
                        <label for="lcInferior" class="sr-only">LC:</label>
                        <input type="number" id="lcInferior" name="lc" class="form-control" placeholder="LC" maxlength="3">
                    </div>
                    <div class="form-group mx-sm-3 mb-2">
                        <label for="mInferior" class="sr-only">M:</label>
                        <input type="number" id="mInferior" name="m" class="form-control" placeholder="M" maxlength="3">
                    </div>
                    <div class="form-group mx-sm-3 mb-2">
                        <label for="lrInferior" class="sr-only">LR:</label>
                        <input type="number" id="lrInferior" name="lr" class="form-control" placeholder="LR" maxlength="3">
                    </div>
                    <button type="button" class="btn btn-primary mb-2" onclick="updateRuler('Inferior')">Inserir</button>
                </form>
                <div class="ruler">
                    <div class="lc" id="lcDisplayInferior"></div>
                    <div class="m" id="mDisplayInferior"></div>
                    <div class="lr" id="lrDisplayInferior"></div>
                </div>
                <button class="btn btn-success save-button" onclick="saveToFirebase('Inferior')">Salvar no Firebase</button>
            </div>
            <div class="col-md-4 p-3">
                <h3>Gráfico de Barras Faca Superior</h3>
                <div class="chart-container">
                    <canvas id="percentageChartSuperior"></canvas>
                </div>
                <h3>Gráfico de Barras Faca Inferior</h3>
                <div class="chart-container">
                    <canvas id="percentageChartInferior"></canvas>
                </div>
            </div>
            <div class="col-md-4 p-3">
                <h3>Histórico Faca Superior</h3>
                <div class="history-container">
                    <div class="form-group">
                        <select class="form-control mb-2" id="historyDropdownSuperior1" onchange="updateLineChart('Superior')">
                            <option value="">Selecione a primeira data</option>
                        </select>
                        <select class="form-control mb-2" id="historyDropdownSuperior2" onchange="updateLineChart('Superior')">
                            <option value="">Selecione a segunda data</option>
                        </select>
                    </div>
                    <div id="historyDisplaySuperior" class="history-display"></div>
                </div>
                <h3>Histórico Faca Inferior</h3>
                <div class="history-container">
                    <div class="form-group">
                        <select class="form-control mb-2" id="historyDropdownInferior1" onchange="updateLineChart('Inferior')">
                            <option value="">Selecione a primeira data</option>
                        </select>
                        <select class="form-control mb-2" id="historyDropdownInferior2" onchange="updateLineChart('Inferior')">
                            <option value="">Selecione a segunda data</option>
                        </select>
                    </div>
                    <div id="historyDisplayInferior" class="history-display"></div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <h3>Gráfico de Linha Faca Superior</h3>
                <div class="chart-container">
                    <canvas id="lineChartSuperior" style="max-width: 100%; height: 300px;"></canvas>
                </div>
                <h3>Gráfico de Linha Faca Inferior</h3>
                <div class="chart-container">
                    <canvas id="lineChartInferior" style="max-width: 100%; height: 300px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDEsJtoWAUNgStvKg-0mE5CS8qlSLQt7bA",
            authDomain: "myapp2-a3c3f.firebaseapp.com",
            databaseURL: "https://myapp2-a3c3f-default-rtdb.firebaseio.com",
            projectId: "myapp2-a3c3f",
            storageBucket: "myapp2-a3c3f.appspot.com",
            messagingSenderId: "746305842581",
            appId: "1:746305842581:web:0059c0e45f82fd07a01a9c"
        };

        // Inicializa o Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let percentageChartSuperior, percentageChartInferior, lineChartSuperior, lineChartInferior;

        function updateRuler(type) {
            const lcValue = document.getElementById('lc' + type).value;
            const mValue = document.getElementById('m' + type).value;
            const lrValue = document.getElementById('lr' + type).value;

            document.getElementById('lcDisplay' + type).textContent = lcValue;
            document.getElementById('mDisplay' + type).textContent = mValue;
            document.getElementById('lrDisplay' + type).textContent = lrValue;

            updateCharts(type);
        }

        function updateCharts(type) {
            const lcValue = parseFloat(document.getElementById('lc' + type).value) || 0;
            const mValue = parseFloat(document.getElementById('m' + type).value) || 0;
            const lrValue = parseFloat(document.getElementById('lr' + type).value) || 0;

            const total = lcValue + mValue + lrValue;

            const percentages = {
                lc: ((lcValue / total) * 100).toFixed(2),
                m: ((mValue / total) * 100).toFixed(2),
                lr: ((lrValue / total) * 100).toFixed(2)
            };

            const ctx = document.getElementById('percentageChart' + type).getContext('2d');
            if (type === 'Superior') {
                if (percentageChartSuperior) {
                    percentageChartSuperior.data.datasets[0].data = [percentages.lc, percentages.m, percentages.lr];
                    percentageChartSuperior.update();
                } else {
                    percentageChartSuperior = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['LC', 'M', 'LR'],
                            datasets: [{
                                label: 'Porcentagem',
                                data: [percentages.lc, percentages.m, percentages.lr],
                                backgroundColor: [
                                    'rgba(255, 99, 132, 0.2)',
                                    'rgba(54, 162, 235, 0.2)',
                                    'rgba(75, 192, 192, 0.2)'
                                ],
                                borderColor: [
                                    'rgba(255, 99, 132, 1)',
                                    'rgba(54, 162, 235, 1)',
                                    'rgba(75, 192, 192, 1)'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            plugins: {
                                datalabels: {
                                    anchor: 'end',
                                    align: 'top',
                                    formatter: (value) => `${value}%`,
                                    color: '#000',
                                    font: {
                                        weight: 'bold'
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function (value) {
                                            return value + '%';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            } else {
                if (percentageChartInferior) {
                    percentageChartInferior.data.datasets[0].data = [percentages.lc, percentages.m, percentages.lr];
                    percentageChartInferior.update();
                } else {
                    percentageChartInferior = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['LC', 'M', 'LR'],
                            datasets: [{
                                label: 'Porcentagem',
                                data: [percentages.lc, percentages.m, percentages.lr],
                                backgroundColor: [
                                    'rgba(255, 99, 132, 0.2)',
                                    'rgba(54, 162, 235, 0.2)',
                                    'rgba(75, 192, 192, 0.2)'
                                ],
                                borderColor: [
                                    'rgba(255, 99, 132, 1)',
                                    'rgba(54, 162, 235, 1)',
                                    'rgba(75, 192, 192, 1)'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            plugins: {
                                datalabels: {
                                    anchor: 'end',
                                    align: 'top',
                                    formatter: (value) => `${value}%`,
                                    color: '#000',
                                    font: {
                                        weight: 'bold'
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function (value) {
                                            return value + '%';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }
        }

        function saveToFirebase(type) {
            const lcValue = parseFloat(document.getElementById('lc' + type).value) || 0;
            const mValue = parseFloat(document.getElementById('m' + type).value) || 0;
            const lrValue = parseFloat(document.getElementById('lr' + type).value) || 0;

            const data = {
                lc: lcValue,
                m: mValue,
                lr: lrValue,
                timestamp: Date.now()
            };

            database.ref('laminaData' + type).push(data, (error) => {
                if (error) {
                    alert('Erro ao salvar dados no Firebase.');
                } else {
                    alert('Dados salvos com sucesso!');
                    loadHistoryDropdown(type);
                    updateLineChart(type);
                }
            });

            // Limpar inputs após salvar
            document.getElementById('lc' + type).value = '';
            document.getElementById('m' + type).value = '';
            document.getElementById('lr' + type).value = '';
        }

        function loadHistoryDropdown(type) {
            const dropdown1 = document.getElementById('historyDropdown' + type + '1');
            const dropdown2 = document.getElementById('historyDropdown' + type + '2');
            dropdown1.innerHTML = '<option value="">Selecione a primeira data</option>';
            dropdown2.innerHTML = '<option value="">Selecione a segunda data</option>';

            database.ref('laminaData' + type).orderByChild('timestamp').once('value', (snapshot) => {
                snapshot.forEach((childSnapshot) => {
                    const data = childSnapshot.val();
                    const date = new Date(data.timestamp);
                    const dateString = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                    const option1 = document.createElement('option');
                    const option2 = document.createElement('option');
                    option1.value = childSnapshot.key;
                    option1.textContent = dateString;
                    option2.value = childSnapshot.key;
                    option2.textContent = dateString;
                    dropdown1.appendChild(option1);
                    dropdown2.appendChild(option2);
                });
            });
        }

        function updateLineChart(type) {
            const key1 = document.getElementById('historyDropdown' + type + '1').value;
            const key2 = document.getElementById('historyDropdown' + type + '2').value;

            if (!key1 || !key2) return;

            Promise.all([
                database.ref('laminaData' + type + '/' + key1).once('value'),
                database.ref('laminaData' + type + '/' + key2).once('value')
            ]).then((snapshots) => {
                const data1 = snapshots[0].val();
                const data2 = snapshots[1].val();

                const ctx = document.getElementById('lineChart' + type).getContext('2d');
                if (type === 'Superior') {
                    if (lineChartSuperior) {
                        lineChartSuperior.data.labels = ['LC', 'M', 'LR'];
                        lineChartSuperior.data.datasets[0].label = new Date(data1.timestamp).toLocaleString();
                        lineChartSuperior.data.datasets[0].data = [data1.lc, data1.m, data1.lr];
                        lineChartSuperior.data.datasets[1].label = new Date(data2.timestamp).toLocaleString();
                        lineChartSuperior.data.datasets[1].data = [data2.lc, data2.m, data2.lr];
                        lineChartSuperior.update();
                    } else {
                        lineChartSuperior = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: ['LC', 'M', 'LR'],
                                datasets: [
                                    {
                                        label: new Date(data1.timestamp).toLocaleString(),
                                        data: [data1.lc, data1.m, data1.lr],
                                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                        borderColor: 'rgba(255, 99, 132, 1)',
                                        borderWidth: 1,
                                        fill: false
                                    },
                                    {
                                        label: new Date(data2.timestamp).toLocaleString(),
                                        data: [data2.lc, data2.m, data2.lr],
                                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                        borderColor: 'rgba(54, 162, 235, 1)',
                                        borderWidth: 1,
                                        fill: false
                                    }
                                ]
                            },
                            options: {
                                plugins: {
                                    datalabels: {
                                        anchor: 'end',
                                        align: 'top',
                                        formatter: (value) => `${value}%`,
                                        color: '#000',
                                        font: {
                                            weight: 'bold'
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            callback: function (value) {
                                                return value + '%';
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                } else {
                    if (lineChartInferior) {
                        lineChartInferior.data.labels = ['LC', 'M', 'LR'];
                        lineChartInferior.data.datasets[0].label = new Date(data1.timestamp).toLocaleString();
                        lineChartInferior.data.datasets[0].data = [data1.lc, data1.m, data1.lr];
                        lineChartInferior.data.datasets[1].label = new Date(data2.timestamp).toLocaleString();
                        lineChartInferior.data.datasets[1].data = [data2.lc, data2.m, data2.lr];
                        lineChartInferior.update();
                    } else {
                        lineChartInferior = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: ['LC', 'M', 'LR'],
                                datasets: [
                                    {
                                        label: new Date(data1.timestamp).toLocaleString(),
                                        data: [data1.lc, data1.m, data1.lr],
                                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                        borderColor: 'rgba(255, 99, 132, 1)',
                                        borderWidth: 1,
                                        fill: false
                                    },
                                    {
                                        label: new Date(data2.timestamp).toLocaleString(),
                                        data: [data2.lc, data2.m, data2.lr],
                                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                        borderColor: 'rgba(54, 162, 235, 1)',
                                        borderWidth: 1,
                                        fill: false
                                    }
                                ]
                            },
                            options: {
                                plugins: {
                                    datalabels: {
                                        anchor: 'end',
                                        align: 'top',
                                        formatter: (value) => `${value}%`,
                                        color: '#000',
                                        font: {
                                            weight: 'bold'
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            callback: function (value) {
                                                return value + '%';
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                }
            });
        }

        // Inicializa os gráficos
        window.onload = function() {
            loadHistoryDropdown('Superior');
            loadHistoryDropdown('Inferior');
        };
    </script>
</body>
</html>
