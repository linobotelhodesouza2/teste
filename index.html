<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Régua de Lâmina com Gráfico</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 0;
        }

        .container {
            display: flex;
            width: 100%;
            height: 100vh;
            box-sizing: border-box;
        }

        .column {
            flex: 1;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        .form-container {
            width: 100%;
        }

        form {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
        }

        label, input {
            margin: 5px;
        }

        input {
            width: 50px;
            text-align: center;
        }

        .ruler {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            height: 30px;
            background-color: #f0f0f0;
            border: 2px solid #000;
            position: relative;
            margin-bottom: 20px;
        }

        .ruler div {
            width: 30%;
            text-align: center;
            padding: 5px;
            border: 1px solid #000;
            background-color: #d9d9d9;
            position: absolute;
        }

        .lc {
            left: 0;
        }

        .m {
            left: 50%;
            transform: translateX(-50%);
        }

        .lr {
            right: 0;
        }

        .chart-container {
            width: 100%;
        }

        .save-button {
            margin-top: 10px;
        }

        .history-container {
            width: 100%;
            margin-top: 20px;
        }

        .history-dropdown {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
        }

        .history-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        .history-details {
            width: 50%;
        }

        .history-chart {
            width: 45%;
        }

        @media (max-width: 600px) {
            .container {
                flex-direction: column;
            }

            .column {
                width: 100%;
                padding: 10px;
            }

            .history-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .history-details, .history-chart {
                width: 100%;
                margin-bottom: 10px;
            }

            .chart-container, .history-chart canvas {
                width: 100% !important;
                height: 200px !important;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-database-compat.js"></script>
</head>
<body>
    <div class="container">
        <div class="column">
            <div class="form-container">
                <form id="laminaForm">
                    <label for="lc">LC:</label>
                    <input type="number" id="lc" name="lc" maxlength="3">
                    <label for="m">M:</label>
                    <input type="number" id="m" name="m" maxlength="3">
                    <label for="lr">LR:</label>
                    <input type="number" id="lr" name="lr" maxlength="3">
                    <button type="button" onclick="updateRuler()">Inserir</button>
                </form>
            </div>
            <div class="ruler">
                <div class="lc" id="lcDisplay"></div>
                <div class="m" id="mDisplay"></div>
                <div class="lr" id="lrDisplay"></div>
            </div>
            <button class="save-button" onclick="saveToFirebase()">Salvar no Firebase</button>
        </div>
        <div class="column">
            <div class="chart-container">
                <canvas id="percentageChart"></canvas>
            </div>
        </div>
        <div class="column">
            <div class="history-container">
                <select class="history-dropdown" id="historyDropdown" onchange="loadHistory(this.value)">
                    <option value="">Selecione uma data</option>
                </select>
                <div id="historyDisplay" class="history-display"></div>
            </div>
        </div>
    </div>

    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDEsJtoWAUNgStvKg-0mE5CS8qlSLQt7bA",
            authDomain: "myapp2-a3c3f.firebaseapp.com",
            databaseURL: "https://myapp2-a3c3f-default-rtdb.firebaseio.com",
            projectId: "myapp2-a3c3f",
            storageBucket: "myapp2-a3c3f.appspot.com",
            messagingSenderId: "746305842581",
            appId: "1:746305842581:web:0059c0e45f82fd07a01a9c"
        };

        // Inicializando Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        function updateRuler() {
            const lcValue = parseFloat(document.getElementById('lc').value) || 0;
            const mValue = parseFloat(document.getElementById('m').value) || 0;
            const lrValue = parseFloat(document.getElementById('lr').value) || 0;

            const total = lcValue + mValue + lrValue;
            const lcPercent = total ? (lcValue / total) * 100 : 0;
            const mPercent = total ? (mValue / total) * 100 : 0;
            const lrPercent = total ? (lrValue / total) * 100 : 0;

            document.getElementById('lcDisplay').innerText = lcValue;
            document.getElementById('mDisplay').innerText = mValue;
            document.getElementById('lrDisplay').innerText = lrValue;

            updateChart([lcPercent, mPercent, lrPercent]);
        }

        let chart;

        function updateChart(data) {
            const ctx = document.getElementById('percentageChart').getContext('2d');
            if (chart) {
                chart.data.datasets[0].data = data;
                chart.update();
            } else {
                chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['LC', 'M', 'LR'],
                        datasets: [{
                            data: data,
                            backgroundColor: ['rgba(255, 99, 132, 0.2)', 'rgba(54, 162, 235, 0.2)', 'rgba(75, 192, 192, 0.2)'],
                            borderColor: ['rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)', 'rgba(75, 192, 192, 1)'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        plugins: {
                            datalabels: {
                                anchor: 'end',
                                align: 'top',
                                formatter: (value) => `${value.toFixed(2)}%`,
                                font: {
                                    weight: 'bold'
                                }
                            }
                        },
                        scales: {
                            y: {
                                display: false,
                                beginAtZero: true,
                                max: 100
                            },
                            x: {
                                ticks: {
                                    display: false
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            }
        }

        function saveToFirebase() {
            const lcValue = parseFloat(document.getElementById('lc').value) || 0;
            const mValue = parseFloat(document.getElementById('m').value) || 0;
            const lrValue = parseFloat(document.getElementById('lr').value) || 0;

            const data = {
                lc: lcValue,
                m: mValue,
                lr: lrValue,
                timestamp: Date.now()
            };

            database.ref('laminaData').push(data, (error) => {
                if (error) {
                    alert('Erro ao salvar dados no Firebase.');
                } else {
                    alert('Dados salvos com sucesso!');
                    loadHistoryDropdown();
                }
            });
        }

        function loadHistoryDropdown() {
            const dropdown = document.getElementById('historyDropdown');
            dropdown.innerHTML = '<option value="">Selecione uma data</option>';

            database.ref('laminaData').orderByChild('timestamp').once('value', (snapshot) => {
                snapshot.forEach((childSnapshot) => {
                    const data = childSnapshot.val();
                    const date = new Date(data.timestamp);
                    const dateString = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                    const option = document.createElement('option');
                    option.value = childSnapshot.key;
                    option.textContent = dateString;
                    dropdown.appendChild(option);
                });
            });
        }

        function loadHistory(key) {
            if (!key) return;

            database.ref('laminaData/' + key).once('value', (snapshot) => {
                const data = snapshot.val();

                const historyDisplay = document.getElementById('historyDisplay');
                historyDisplay.innerHTML = '';

                const historyItem = document.createElement('div');
                historyItem.classList.add('history-item');

                const historyDetails = document.createElement('div');
                historyDetails.classList.add('history-details');
                historyDetails.innerHTML = `
                    <p><strong>LC:</strong> ${data.lc}</p>
                    <p><strong>M:</strong> ${data.m}</p>
                    <p><strong>LR:</strong> ${data.lr}</p>
                    <p><strong>Data:</strong> ${new Date(data.timestamp).toLocaleString()}</p>
                `;

                const historyChartContainer = document.createElement('div');
                historyChartContainer.classList.add('history-chart');
                const historyChart = document.createElement('canvas');
                historyChartContainer.appendChild(historyChart);

                historyItem.appendChild(historyDetails);
                historyItem.appendChild(historyChartContainer);
                historyDisplay.appendChild(historyItem);

                const total = data.lc + data.m + data.lr;
                const lcPercent = total ? (data.lc / total) * 100 : 0;
                const mPercent = total ? (data.m / total) * 100 : 0;
                const lrPercent = total ? (data.lr / total) * 100 : 0;

                new Chart(historyChart, {
                    type: 'bar',
                    data: {
                        labels: ['LC', 'M', 'LR'],
                        datasets: [{
                            label: 'Porcentagem',
                            data: [lcPercent, mPercent, lrPercent],
                            backgroundColor: ['rgba(255, 99, 132, 0.2)', 'rgba(54, 162, 235, 0.2)', 'rgba(75, 192, 192, 0.2)'],
                            borderColor: ['rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)', 'rgba(75, 192, 192, 1)'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        plugins: {
                            datalabels: {
                                anchor: 'end',
                                align: 'top',
                                formatter: (value) => `${value.toFixed(2)}%`,
                                font: {
                                    weight: 'bold'
                                }
                            }
                        },
                        scales: {
                            y: {
                                display: false,
                                beginAtZero: true,
                                max: 100
                            },
                            x: {
                                ticks: {
                                    display: false
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            });
        }

        document.addEventListener('DOMContentLoaded', loadHistoryDropdown);
    </script>
</body>
</html>
