<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Gerenciamento de Facas</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        .container {
            margin-top: 20px;
        }
        .row {
            margin-bottom: 20px;
        }
        #chartContainer {
            display: flex;
            justify-content: space-around;
        }
        #reportContent {
            display: flex;
            justify-content: space-around;
        }
        .input-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
</head>
<body>
    <div class="container">
        <h1>Gerenciamento de Facas</h1>
        <div class="row">
            <div class="col-md-4">
                <input type="date" id="dataLancamento" class="form-control mb-2">
                <div class="input-container">
                    <input type="number" id="facaSuperiorLR" class="form-control" placeholder="Superior L.R">
                    <input type="number" id="facaSuperiorM" class="form-control" placeholder="Superior M">
                    <input type="number" id="facaSuperiorLC" class="form-control" placeholder="Superior L.C">
                </div>
                <div class="input-container">
                    <input type="number" id="facaInferiorLR" class="form-control" placeholder="Inferior L.R">
                    <input type="number" id="facaInferiorM" class="form-control" placeholder="Inferior M">
                    <input type="number" id="facaInferiorLC" class="form-control" placeholder="Inferior L.C">
                </div>
                <button onclick="salvarDados()" class="btn btn-primary">Salvar</button>
                <button onclick="deletarDados()" class="btn btn-danger">Deletar</button>
                <div id="successMessage" class="alert alert-success mt-2" style="display: none;"></div>
                <div id="errorMessage" class="alert alert-danger mt-2" style="display: none;">Erro ao salvar os dados.</div>
            </div>
            <div class="col-md-8">
                <select id="launchSelector" class="form-control mb-2" onchange="loadDataByLaunch(this.value)">
                    <option value="">Selecione um lançamento</option>
                </select>
                <div id="chartContainer">
                    <canvas id="chartFacaSuperior"></canvas>
                    <canvas id="chartFacaInferior"></canvas>
                </div>
                <div id="reportContent" class="mt-4"></div>
            </div>
        </div>
    </div>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDEsJtoWAUNgStvKg-0mE5CS8qlSLQt7bA",
            authDomain: "myapp2-a3c3f.firebaseapp.com",
            databaseURL: "https://myapp2-a3c3f-default-rtdb.firebaseio.com",
            projectId: "myapp2-a3c3f",
            storageBucket: "myapp2-a3c3f.appspot.com",
            messagingSenderId: "746305842581",
            appId: "1:746305842581:web:0059c0e45f82fd07a01a9c"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const targetValues = {
            superior: { lr: 68.5, m: 69, lc: 68.9 },
            inferior: { lr: 65, m: 65, lc: 65 }
        };

        function salvarDados() {
            const dataLancamento = document.getElementById('dataLancamento').value;
            const dadosFacaSuperior = {
                lr: parseFloat(document.getElementById('facaSuperiorLR').value),
                m: parseFloat(document.getElementById('facaSuperiorM').value),
                lc: parseFloat(document.getElementById('facaSuperiorLC').value)
            };
            const dadosFacaInferior = {
                lr: parseFloat(document.getElementById('facaInferiorLR').value),
                m: parseFloat(document.getElementById('facaInferiorM').value),
                lc: parseFloat(document.getElementById('facaInferiorLC').value)
            };

            const newLaunchKey = database.ref().child('facas').push().key;
            const updates = {};
            updates[`facas/${newLaunchKey}/superior`] = dadosFacaSuperior;
            updates[`facas/${newLaunchKey}/inferior`] = dadosFacaInferior;
            updates[`facas/${newLaunchKey}/data`] = dataLancamento;

            database.ref().update(updates)
                .then(() => {
                    loadAllLaunches();
                    document.getElementById('successMessage').innerText = 'Dados salvos com sucesso!';
                    document.getElementById('successMessage').style.display = 'block';
                    setTimeout(() => document.getElementById('successMessage').style.display = 'none', 3000);
                })
                .catch((error) => {
                    console.error('Erro ao salvar dados:', error);
                    document.getElementById('errorMessage').style.display = 'block';
                    setTimeout(() => document.getElementById('errorMessage').style.display = 'none', 3000);
                });
        }

        function deletarDados() {
            const selectedLaunch = document.getElementById('launchSelector').value;

            if (!selectedLaunch) {
                alert('Por favor, selecione um lançamento.');
                return;
            }

            database.ref(`facas/${selectedLaunch}`).remove()
                .then(() => {
                    loadAllLaunches();
                    document.getElementById('successMessage').innerText = 'Lançamento deletado com sucesso!';
                    document.getElementById('successMessage').style.display = 'block';
                    setTimeout(() => document.getElementById('successMessage').style.display = 'none', 3000);
                })
                .catch((error) => {
                    console.error('Erro ao deletar dados:', error);
                    document.getElementById('errorMessage').style.display = 'block';
                    setTimeout(() => document.getElementById('errorMessage').style.display = 'none', 3000);
                });
        }

        function loadAllLaunches() {
            const launchSelector = document.getElementById('launchSelector');
            launchSelector.innerHTML = '<option value="">Selecione um lançamento</option>'; // Limpar opções anteriores

            database.ref('facas').once('value', (snapshot) => {
                const data = snapshot.val() || {};
                Object.keys(data).forEach(launchKey => {
                    const option = document.createElement('option');
                    const date = data[launchKey].data;
                    option.value = launchKey;
                    option.textContent = `Lançamento ${Object.keys(data).indexOf(launchKey) + 1} - ${date}`;
                    launchSelector.appendChild(option);
                });
            });
        }

        function loadDataByLaunch(launchKey) {
            if (!launchKey) return;

            database.ref(`facas/${launchKey}`).once('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    updateChart(chartFacaSuperior, data.superior, targetValues.superior);
                    updateChart(chartFacaInferior, data.inferior, targetValues.inferior);
                    generateReport(data);
                }
            });
        }

        function updateChart(chart, data, targetValues) {
            const total = Object.values(targetValues).reduce((acc, val) => acc + val, 0);
            const percentageData = Object.keys(data).map(key => {
                const percentage = total > 0 ? (data[key] / targetValues[key] * 100).toFixed(1) : 0;
                return `${percentage}% (${targetValues[key]})`; // Adicionar o valor alvo entre parênteses
            });

            chart.data.datasets[0].data = percentageData;
            chart.data.datasets[0].datalabels = {
                formatter: (value, context) => {
                    const label = context.chart.data.labels[context.dataIndex];
                    const valueWithoutPercentage = value.split('%')[0]; // Remover o símbolo de porcentagem
                    const targetValue = targetValues[label.toLowerCase()];
                    return `${valueWithoutPercentage}% (${targetValue})`; // Adicionar o valor alvo entre parênteses
                },
                color: 'black',
                anchor: 'end',
                align: 'start'
            };
            chart.update();
        }

        function generateReport(data) {
            const reportContent = document.getElementById('reportContent');
            reportContent.innerHTML = `
                <div>
                    <h4>Faca Superior</h4>
                    <p>L.R: ${data.superior.lr} (68.5)</p>
                    <p>M: ${data.superior.m} (69)</p>
                    <p>L.C: ${data.superior.lc} (68.9)</p>
                </div>
                <div>
                    <h4>Faca Inferior</h4>
                    <p>L.R: ${data.inferior.lr} (65)</p>
                    <p>M: ${data.inferior.m} (65)</p>
                    <p>L.C: ${data.inferior.lc} (65)</p>
                </div>
            `;
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadAllLaunches();

            const ctxSuperior = document.getElementById('chartFacaSuperior').getContext('2d');
            const ctxInferior = document.getElementById('chartFacaInferior').getContext('2d');

            chartFacaSuperior = new Chart(ctxSuperior, {
                type: 'bar',
                data: {
                    labels: ['LR', 'M', 'LC'],
                    datasets: [{
                        label: 'Faca Superior',
                        data: [],
                        backgroundColor: ['rgba(75, 192, 192, 0.2)'],
                        borderColor: ['rgba(75, 192, 192, 1)'],
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true
                            }
                        }]
                    },
                    plugins: {
                        datalabels: {
                            display: true,
                            color: 'black',
                            anchor: 'end',
                            align: 'start'
                        }
                    }
                }
            });

            chartFacaInferior = new Chart(ctxInferior, {
                type: 'bar',
                data: {
                    labels: ['LR', 'M', 'LC'],
                    datasets: [{
                        label: 'Faca Inferior',
                        data: [],
                        backgroundColor: ['rgba(153, 102, 255, 0.2)'],
                        borderColor: ['rgba(153, 102, 255, 1)'],
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true
                            }
                        }]
                    },
                    plugins: {
                        datalabels: {
                            display: true,
                            color: 'black',
                            anchor: 'end',
                            align: 'start'
                        }
                    }
                }
            });
        });
    </script>
</body>
</html>
