<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Produtos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">Cadastro de Produtos</h1>
        <form id="produtoForm">
            <div class="mb-3">
                <label for="produto" class="form-label">Produto</label>
                <input type="text" class="form-control" id="produto" required>
            </div>
            <div class="row mb-3">
                <div class="col">
                    <label for="perimetro" class="form-label">Perímetro</label>
                    <input type="text" class="form-control" id="perimetro" maxlength="5" required>
                </div>
                <div class="col">
                    <label for="corte" class="form-label">Corte</label>
                    <input type="text" class="form-control" id="corte" maxlength="5" required>
                </div>
                <div class="col">
                    <label for="velocidade" class="form-label">Velocidade</label>
                    <input type="text" class="form-control" id="velocidade" maxlength="5" required>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col">
                    <label for="chagrim" class="form-label">Chagrim</label>
                    <input type="text" class="form-control" id="chagrim" maxlength="5" required>
                </div>
                <div class="col">
                    <label for="repeticao" class="form-label">Repetição</label>
                    <input type="text" class="form-control" id="repeticao" maxlength="5" required>
                </div>
            </div>
            <div class="mb-3">
                <label for="comentario" class="form-label">Comentário</label>
                <textarea class="form-control" id="comentario" rows="3"></textarea>
            </div>
            <div class="mb-3">
                <label for="imagemProduto" class="form-label">Imagem do Produto</label>
                <input type="file" class="form-control" id="imagemProduto" accept="image/*">
            </div>
            <button type="submit" class="btn btn-primary">Salvar</button>
        </form>

        <h2 class="mt-5">Produtos Salvos</h2>
        <ul id="produtosSalvos" class="list-group">
            <!-- Produtos serão listados aqui -->
        </ul>

        <div id="produtoDetalhes" style="display: none;">
            <h3 class="mt-5">Detalhes do Produto</h3>
            <p><strong>Produto:</strong> <span id="detNome"></span></p>
            <p><strong>Perímetro:</strong> <span id="detPerimetro"></span></p>
            <p><strong>Corte:</strong> <input type="text" id="detCorte"></p>
            <p><strong>Chagrim:</strong> <span id="detChagrim"></span></p>
            <p><strong>Repetição:</strong> <span id="detRepeticao"></span></p>
            <p><strong>Velocidade:</strong> <input type="text" id="detVelocidade"></p>
            <img id="detImagem" src="" alt="Imagem do Produto" style="max-width: 100%; height: auto;">
            <button id="salvarEdicao" class="btn btn-success mt-3">Salvar Edição</button>
            <button id="excluirProduto" class="btn btn-danger mt-3">Excluir Produto</button>
        </div>

        <div id="successMessage" class="alert alert-success mt-3" style="display: none;">
            <!-- Mensagem de sucesso será exibida aqui -->
        </div>

        <h2 class="mt-5">Comentários</h2>
        <ul id="comentariosList" class="list-group">
            <!-- Comentários serão listados aqui -->
        </ul>

        <form id="novoComentarioForm" class="mt-3">
            <div class="mb-3">
                <label for="novoComentario" class="form-label">Novo Comentário</label>
                <textarea class="form-control" id="novoComentario" rows="3"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Adicionar Comentário</button>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script>
        // Inicialização do Supabase
        const supabaseUrl = 'https://vvllgovellxentijblzw.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ2bGxnb3ZlbGx4ZW50aWpibHp3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjQ2MTM2NDcsImV4cCI6MjA0MDE4OTY0N30.KIMgXbDpDDb_JjmgC35r18g86QX2YhlLPYVNEF03aFk';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        let produtoKey = null;

        document.getElementById('produtoForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const produto = document.getElementById('produto').value;
            const perimetro = document.getElementById('perimetro').value;
            const corte = document.getElementById('corte').value;
            const chagrim = document.getElementById('chagrim').value;
            const repeticao = document.getElementById('repeticao').value;
            const velocidade = document.getElementById('velocidade').value;
            const comentario = document.getElementById('comentario').value;
            const imagemProduto = document.getElementById('imagemProduto').files[0];

            let imagemBase64 = null;
            if (imagemProduto) {
                imagemBase64 = await toBase64(imagemProduto);
            }

            const { data, error } = await supabase.from('produtos').insert([
                { produto, perimetro, corte, chagrim, repeticao, velocidade, comentario, imagem: imagemBase64 }
            ]);

            if (error) {
                console.error('Erro ao salvar os dados:', error);
            } else {
                console.log('Dados salvos:', data);
                atualizarListaProdutos();
                document.getElementById('produtoForm').reset();
                mostrarMensagemSucesso('Dados salvos com sucesso!');
            }
        });

        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function atualizarListaProdutos() {
            const { data, error } = await supabase.from('produtos').select('*');
            if (error) {
                console.error('Erro ao carregar produtos:', error);
                return;
            }

            const produtosSalvos = document.getElementById('produtosSalvos');
            produtosSalvos.innerHTML = '';
            data.forEach(produto => {
                const li = document.createElement('li');
                li.classList.add('dropdown-item');
                li.textContent = produto.produto;
                li.addEventListener('click', () => mostrarDetalhesProduto(produto));
                produtosSalvos.appendChild(li);
            });
        }

        async function mostrarDetalhesProduto(produto) {
            produtoKey = produto.id;

            document.getElementById('detNome').textContent = produto.produto;
            document.getElementById('detPerimetro').textContent = produto.perimetro;
            document.getElementById('detCorte').value = produto.corte;
            document.getElementById('detChagrim').textContent = produto.chagrim;
            document.getElementById('detRepeticao').textContent = produto.repeticao;
            document.getElementById('detVelocidade').value = produto.velocidade;
            document.getElementById('detImagem').src = produto.imagem;

            document.getElementById('produtoDetalhes').style.display = 'block';
            atualizarListaComentarios(produtoKey);
        }

        async function atualizarListaComentarios(produtoId) {
            const { data, error } = await supabase.from('comentarios').select('*').eq('produto_id', produtoId);
            if (error) {
                console.error('Erro ao carregar comentários:', error);
                return;
            }

            const comentariosList = document.getElementById('comentariosList');
            comentariosList.innerHTML = '';
            data.forEach(comentario => {
                const li = document.createElement('li');
                li.classList.add('list-group-item');
                li.textContent = comentario.comentario;
                comentariosList.appendChild(li);
            });
        }

        document.getElementById('novoComentarioForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const novoComentario = document.getElementById('novoComentario').value;

            const { data, error } = await supabase.from('comentarios').insert([
                { comentario: novoComentario, produto_id: produtoKey }
            ]);

            if (error) {
                console.error('Erro ao adicionar comentário:', error);
            } else {
                console.log('Comentário adicionado:', data);
                atualizarListaComentarios(produtoKey);
                document.getElementById('novoComentarioForm').reset();
            }
        });

        document.getElementById('salvarEdicao').addEventListener('click', async function() {
            const novoCorte = document.getElementById('detCorte').value;
            const novaVelocidade = document.getElementById('detVelocidade').value;

            const { data, error } = await supabase.from('produtos').update({
                corte: novoCorte,
                velocidade: novaVelocidade
            }).eq('id', produtoKey);

            if (error) {
                console.error('Erro ao salvar edição:', error);
            } else {
                console.log('Produto atualizado:', data);
                mostrarMensagemSucesso('Produto atualizado com sucesso!');
                atualizarListaProdutos();
            }
        });

        document.getElementById('excluirProduto').addEventListener('click', async function() {
            const { data, error } = await supabase.from('produtos').delete().eq('id', produtoKey);

            if (error) {
                console.error('Erro ao excluir produto:', error);
            } else {
                console.log('Produto excluído:', data);
                document.getElementById('produtoDetalhes').style.display = 'none';
                mostrarMensagemSucesso('Produto excluído com sucesso!');
                atualizarListaProdutos();
            }
        });

        function mostrarMensagemSucesso(mensagem) {
            const successMessage = document.getElementById('successMessage');
            successMessage.textContent = mensagem;
            successMessage.style.display = 'block';
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 3000);
        }

        // Atualiza a lista de produtos ao carregar a página
        atualizarListaProdutos();
    </script>
</body>
</html>
