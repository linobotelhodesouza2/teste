<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Régua de Lâmina com Gráficos</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
            padding: 0 10px;
        }

        .form-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 1200px;
        }

        .section {
            margin-bottom: 30px;
        }

        form {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 10px;
        }

        label, input {
            margin-right: 10px;
        }

        input {
            width: 50px; /* Pequeno o suficiente para 3 números */
            text-align: center;
            margin: 5px;
        }

        .ruler {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            height: 50px; /* Altura da lâmina */
            background-color: #f0f0f0; /* Cor da lâmina */
            border: 2px solid #000; /* Borda da lâmina */
            position: relative;
            margin-bottom: 20px; /* Espaçamento entre a lâmina e o gráfico */
        }

        .ruler div {
            width: 30%;
            text-align: center;
            padding: 5px;
            border: 1px solid #000;
            background-color: #d9d9d9; /* Cor das divisões */
            position: absolute;
        }

        .lc {
            left: 0;
        }

        .m {
            left: 50%;
            transform: translateX(-50%);
        }

        .lr {
            right: 0;
        }

        .chart-container {
            width: 100%;
            margin-top: 10px; /* Ajusta o espaço entre o gráfico e o formulário */
        }

        .save-button {
            margin-top: 20px;
        }

        .history-container {
            width: 100%;
            max-width: 1200px;
            margin-top: 30px;
            display: flex;
            flex-direction: column;
        }

        .history-dropdown {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
        }

        .history-display {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
        }

        .history-info {
            width: 100%;
            max-width: 50%;
            padding: 10px;
        }

        .history-chart {
            width: 100%;
            max-width: 50%;
            padding: 10px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-database-compat.js"></script>
</head>
<body>
    <div class="form-container">
        <div class="section">
            <h2>Lançamento Antes</h2>
            <form id="laminaFormBefore">
                <label for="lcBefore">LC:</label>
                <input type="number" id="lcBefore" name="lcBefore" maxlength="3" oninput="updateRuler('Before')">
                <label for="mBefore">M:</label>
                <input type="number" id="mBefore" name="mBefore" maxlength="3" oninput="updateRuler('Before')">
                <label for="lrBefore">LR:</label>
                <input type="number" id="lrBefore" name="lrBefore" maxlength="3" oninput="updateRuler('Before')">
            </form>
            <div class="ruler">
                <div class="lc lcBefore" id="lcDisplayBefore"></div>
                <div class="m mBefore" id="mDisplayBefore"></div>
                <div class="lr lrBefore" id="lrDisplayBefore"></div>
            </div>
            <div class="chart-container">
                <canvas id="percentageChartBefore"></canvas>
            </div>
        </div>

        <div class="section">
            <h2>Lançamento Depois</h2>
            <form id="laminaFormAfter">
                <label for="lcAfter">LC:</label>
                <input type="number" id="lcAfter" name="lcAfter" maxlength="3" oninput="updateRuler('After')">
                <label for="mAfter">M:</label>
                <input type="number" id="mAfter" name="mAfter" maxlength="3" oninput="updateRuler('After')">
                <label for="lrAfter">LR:</label>
                <input type="number" id="lrAfter" name="lrAfter" maxlength="3" oninput="updateRuler('After')">
            </form>
            <div class="ruler">
                <div class="lc lcAfter" id="lcDisplayAfter"></div>
                <div class="m mAfter" id="mDisplayAfter"></div>
                <div class="lr lrAfter" id="lrDisplayAfter"></div>
            </div>
            <div class="chart-container">
                <canvas id="percentageChartAfter"></canvas>
            </div>
        </div>

        <button class="save-button" onclick="saveToFirebase()">Salvar no Firebase</button>
    </div>

    <div class="history-container">
        <select class="history-dropdown" id="historyDropdown" onchange="loadHistory(this.value)">
            <option value="">Selecione uma data</option>
        </select>
        <div class="history-display" id="historyDisplay">
            <div class="history-info" id="historyInfo"></div>
            <div class="history-chart">
                <canvas id="historyChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDEsJtoWAUNgStvKg-0mE5CS8qlSLQt7bA",
            authDomain: "myapp2-a3c3f.firebaseapp.com",
            databaseURL: "https://myapp2-a3c3f-default-rtdb.firebaseio.com",
            projectId: "myapp2-a3c3f",
            storageBucket: "myapp2-a3c3f.appspot.com",
            messagingSenderId: "746305842581",
            appId: "1:746305842581:web:0059c0e45f82fd07a01a9c"
        };

        // Inicializando Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        function updateRuler(type) {
            const lcValue = parseFloat(document.getElementById(`lc${type}`).value) || 0;
            const mValue = parseFloat(document.getElementById(`m${type}`).value) || 0;
            const lrValue = parseFloat(document.getElementById(`lr${type}`).value) || 0;

            const total = lcValue + mValue + lrValue;
            const lcPercent = total ? (lcValue / total) * 100 : 0;
            const mPercent = total ? (mValue / total) * 100 : 0;
            const lrPercent = total ? (lrValue / total) * 100 : 0;

            document.getElementById(`lcDisplay${type}`).innerText = lcValue;
            document.getElementById(`mDisplay${type}`).innerText = mValue;
            document.getElementById(`lrDisplay${type}`).innerText = lrValue;

            updateChart(`${type}`, [lcPercent, mPercent, lrPercent]);
        }

        let chartBefore, chartAfter;

        function updateChart(type, data) {
            const ctx = document.getElementById(`percentageChart${type}`).getContext('2d');
            if (type === 'Before') {
                if (chartBefore) {
                    chartBefore.data.datasets[0].data = data;
                    chartBefore.update();
                } else {
                    chartBefore = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['LC', 'M', 'LR'],
                            datasets: [{
                                data: data,
                                backgroundColor: ['rgba(255, 99, 132, 0.2)', 'rgba(54, 162, 235, 0.2)', 'rgba(75, 192, 192, 0.2)'],
                                borderColor: ['rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)', 'rgba(75, 192, 192, 1)'],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            plugins: {
                                datalabels: {
                                    anchor: 'end',
                                    align: 'top',
                                    formatter: (value) => `${value.toFixed(2)}%`,
                                    font: {
                                        weight: 'bold'
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    display: false,
                                    beginAtZero: true,
                                    max: 100
                                }
                            }
                        },
                        plugins: [ChartDataLabels]
                    });
                }
            } else {
                if (chartAfter) {
                    chartAfter.data.datasets[0].data = data;
                    chartAfter.update();
                } else {
                    chartAfter = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['LC', 'M', 'LR'],
                            datasets: [{
                                data: data,
                                backgroundColor: ['rgba(255, 99, 132, 0.2)', 'rgba(54, 162, 235, 0.2)', 'rgba(75, 192, 192, 0.2)'],
                                borderColor: ['rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)', 'rgba(75, 192, 192, 1)'],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            plugins: {
                                datalabels: {
                                    anchor: 'end',
                                    align: 'top',
                                    formatter: (value) => `${value.toFixed(2)}%`,
                                    font: {
                                        weight: 'bold'
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    display: false,
                                    beginAtZero: true,
                                    max: 100
                                }
                            }
                        },
                        plugins: [ChartDataLabels]
                    });
                }
            }
        }

        function saveToFirebase() {
            const lcBefore = parseFloat(document.getElementById('lcBefore').value) || 0;
            const mBefore = parseFloat(document.getElementById('mBefore').value) || 0;
            const lrBefore = parseFloat(document.getElementById('lrBefore').value) || 0;
            const lcAfter = parseFloat(document.getElementById('lcAfter').value) || 0;
            const mAfter = parseFloat(document.getElementById('mAfter').value) || 0;
            const lrAfter = parseFloat(document.getElementById('lrAfter').value) || 0;

            const totalBefore = lcBefore + mBefore + lrBefore;
            const lcPercentBefore = totalBefore ? (lcBefore / totalBefore) * 100 : 0;
            const mPercentBefore = totalBefore ? (mBefore / totalBefore) * 100 : 0;
            const lrPercentBefore = totalBefore ? (lrBefore / totalBefore) * 100 : 0;

            const totalAfter = lcAfter + mAfter + lrAfter;
            const lcPercentAfter = totalAfter ? (lcAfter / totalAfter) * 100 : 0;
            const mPercentAfter = totalAfter ? (mAfter / totalAfter) * 100 : 0;
            const lrPercentAfter = totalAfter ? (lrAfter / totalAfter) * 100 : 0;

            const timestamp = new Date().toISOString();
            const data = {
                before: {
                    lc: lcBefore,
                    m: mBefore,
                    lr: lrBefore,
                    lcPercent: lcPercentBefore,
                    mPercent: mPercentBefore,
                    lrPercent: lrPercentBefore
                },
                after: {
                    lc: lcAfter,
                    m: mAfter,
                    lr: lrAfter,
                    lcPercent: lcPercentAfter,
                    mPercent: mPercentAfter,
                    lrPercent: lrPercentAfter
                },
                timestamp: timestamp
            };

            if (confirm('Deseja editar a data e hora de lançamento?')) {
                const newTimestamp = prompt('Digite a nova data e hora no formato YYYY-MM-DDTHH:MM:SSZ', timestamp);
                if (newTimestamp) {
                    data.timestamp = newTimestamp;
                }
            }

            const ref = database.ref(`laminaData/${data.timestamp}`);
            ref.set(data)
                .then(() => {
                    alert('Dados salvos com sucesso!');
                    loadHistoryDropdown();
                })
                .catch((error) => {
                    alert('Erro ao salvar dados: ' + error.message);
                });
        }

        function loadHistoryDropdown() {
            const dropdown = document.getElementById('historyDropdown');
            dropdown.innerHTML = '<option value="">Selecione uma data</option>'; // Reset dropdown

            database.ref('laminaData').once('value', (snapshot) => {
                snapshot.forEach((childSnapshot) => {
                    const key = childSnapshot.key;
                    const data = childSnapshot.val();
                    const date = new Date(data.timestamp).toLocaleString();
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = date;
                    dropdown.appendChild(option);
                });
            });
        }

        let historyChart;

        function loadHistory(key) {
            if (!key) return;

            database.ref(`laminaData/${key}`).once('value', (snapshot) => {
                const data = snapshot.val();
                const lcPercentBefore = data.before.lcPercent;
                const mPercentBefore = data.before.mPercent;
                const lrPercentBefore = data.before.lrPercent;
                const lcPercentAfter = data.after.lcPercent;
                const mPercentAfter = data.after.mPercent;
                const lrPercentAfter = data.after.lrPercent;

                document.getElementById('historyInfo').innerHTML = `
                    <p><strong>LC Antes:</strong> ${data.before.lc}</p>
                    <p><strong>M Antes:</strong> ${data.before.m}</p>
                    <p><strong>LR Antes:</strong> ${data.before.lr}</p>
                    <p><strong>LC Depois:</strong> ${data.after.lc}</p>
                    <p><strong>M Depois:</strong> ${data.after.m}</p>
                    <p><strong>LR Depois:</strong> ${data.after.lr}</p>
                `;

                const ctx = document.getElementById('historyChart').getContext('2d');
                if (historyChart) {
                    historyChart.data.datasets[0].data = [lcPercentBefore, mPercentBefore, lrPercentBefore];
                    historyChart.data.datasets[1].data = [lcPercentAfter, mPercentAfter, lrPercentAfter];
                    historyChart.update();
                } else {
                    historyChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['LC', 'M', 'LR'],
                            datasets: [
                                {
                                    label: 'Antes',
                                    data: [lcPercentBefore, mPercentBefore, lrPercentBefore],
                                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                    borderColor: 'rgba(54, 162, 235, 1)',
                                    borderWidth: 1
                                },
                                {
                                    label: 'Depois',
                                    data: [lcPercentAfter, mPercentAfter, lrPercentAfter],
                                    backgroundColor: 'rgba(75, 192, 192, 0.6)',
                                    borderColor: 'rgba(75, 192, 192, 1)',
                                    borderWidth: 1
                                }
                            ]
                        },
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100
                                }
                            },
                            plugins: {
                                datalabels: {
                                    anchor: 'end',
                                    align: 'top',
                                    formatter: (value) => `${value.toFixed(2)}%`,
                                    font: {
                                        weight: 'bold'
                                    }
                                }
                            }
                        },
                        plugins: [ChartDataLabels]
                    });
                }
            });
        }

        // Carregar o dropdown ao carregar a página
        window.onload = loadHistoryDropdown;
    </script>
</body>
</html>
